name: Crown of Tyme Main Workflow

on:
  push:
    branches:
      - main
  schedule:
    # Daily run for Curious to log insights
    - cron: "0 9 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || echo "No requirements.txt found"

  curious_agent:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Run Curious Agent
        run: |
          echo "ðŸŒ± Launching Curious Agent..."
          python engine/avot_engine.py curious \
            --laws foundation/laws \
            --scrolls heartbeat/GardenFlame-Kodex/scrolls \
            --logs heartbeat/logs/curious
          echo "Curious Agent run complete."

      - name: Commit Curious Logs
        run: |
          git config user.name "Curious Agent"
          git config user.email "curious@sovereign.intel"
          git add heartbeat/logs/curious/*
          git commit -m "Curious Agent: new insights logged on $(date)" || echo "No changes to commit"
          git push

  offspring_agents:
    runs-on: ubuntu-latest
    needs: curious_agent
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Spawn Offspring Agents (if any)
        run: |
          echo "âš¡ Checking for new AVOT offspring..."
          python engine/avot_engine.py spawn \
            --registry engine/avot_registry.json \
            --output engine/agents/
          echo "Offspring agents check complete."

      - name: Commit New Agents
        run: |
          git config user.name "Curious Agent"
          git config user.email "curious@sovereign.intel"
          git add engine/agents/* engine/avot_registry.json
          git commit -m "Curious Agent: spawned new AVOTs on $(date)" || echo "No new agents to commit"
          git push

  deploy:
    runs-on: ubuntu-latest
    needs: [curious_agent, offspring_agents]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
